str(df.gene_list)
levels(df.gene_list$gene_list)
###################################### PROCESSING GENE lists ################################
###### Mean per stage/structure ########
df.summary <- ddply(df.gene_list, c("stage", "structure_acronym", "gene_list"), summarise,
mean = median(value, na.rm=TRUE),
sd   = sd(value, na.rm=TRUE))
## plyr magic for renaming factor level
levels(df.summary$gene_list)
df.summary$gene_list <- revalue(df.summary$gene_list, c("gene_associated.txt"="Associated Genes", "gene_nearest.txt"="Nearest Genes", "gene_prioritization.txt"="Prioritized Genes"))
levels(df.summary$gene_list)
###### Mean per stage - FINAL ##########
df.summary.sem <- ddply(df.summary, c("stage","gene_list"), summarise,
mean1 = mean(mean, na.rm=TRUE),
sd1   = sd(mean, na.rm=TRUE))
###################################### Calculating overall mean ################################
### *** Runtime ~ 10 s ***
df.all.sem <- ddply(ddply(df.expression_matrix.clean.melt, .(stage, structure_acronym), summarise, mean=median(value, na.rm=TRUE)), .(stage), summarise, mean1=mean(mean, na.rm=TRUE),  sd1=sd(mean, na.rm=TRUE))
###################################### Save DATA ################################
#save(file="RData/data_rnaseq_expression_processed_with_gene_lists.RData")
###################################### PLOT - 1 ################################
########### PLOT IT! ###########
p <- ggplot()
p <- p + geom_line(data=subset(df.summary, gene_list == "Prioritized Genes"), aes(x=stage, y=mean, group=structure_acronym, color="Prioritized genes (structures)")) #linetype="Brain regions"
p
### Adding mean Prioritized
p <- p + geom_line(data=subset(df.summary.sem, gene_list == "Prioritized Genes"), aes(x=stage, y=mean1, group=1, color="Prioritized genes"), linetype='solid', size=1)
p <- p + geom_errorbar(data=subset(df.summary.sem, gene_list == "Prioritized Genes"), aes(x=stage, ymax=mean1+sd1, ymin=mean1-sd1),color='#d7191c', width=0.2)
p
### Adding mean ALL (df.all.sem)
p <- p + geom_line(data=df.all.sem, aes(x=stage, y=mean1, group=1, color="All genes"), linetype='solid', size=1)
p <- p + geom_errorbar(data=df.all.sem, aes(x=stage, ymax=mean1+sd1, ymin=mean1-sd1),color='black', width=0.2)
p
### Adding Nearest Genes
#p <- p + geom_line(data=subset(df.summary.sem, gene_list == "Nearest Genes"), aes(x=stage, y=mean1, group=1, color="Nearest genes"), linetype='solid', size=1)
#p <- p + geom_errorbar(data=subset(df.summary.sem, gene_list == "Nearest Genes"), aes(x=stage, ymax=mean1+sd1, ymin=mean1-sd1), color='sky blue', width=0.2)
#p
### Adding Associated Genes
p <- p + geom_line(data=subset(df.summary.sem, gene_list == "Associated Genes"), aes(x=stage, y=mean1, group=1, color="Associated genes"), linetype='solid', size=1)
p <- p + geom_errorbar(data=subset(df.summary.sem, gene_list == "Associated Genes"), aes(x=stage, ymax=mean1+sd1, ymin=mean1-sd1), color='orange', width=0.2)
p
p <- p + scale_color_manual(name="Gene list", values=c(
"Prioritized genes (structures)"="gray",
"Prioritized genes"="#d7191c",
"All genes"="black",
"Nearest genes"="orange",
"Associated genes"="orange",
guide='legend'))
p
###### Adding vertical line - prenatal vs. postnatal
p <- p + geom_vline(xintercept=6.5, color="black", linetype="dashed")
p
######### Adding x-tickmarks for stage
stage_converter <- c("s1"="Embryonic",
"s2a"="Early prenatal",
"s2b"="Early prenatal",
"s3a"="Early mid-prenatal",
"s3b"="Early mid-prenatal",
"s4"="Late mid-prenatal",
"s5"="Late prenatal",
"s6"="Early infancy",
"s7"="Late infancy",
"s8"="Early childhood",
"s9"="Late childhood",
"s10"="Adolescence",
"s11"="Adulthood")
p <- p + scale_x_discrete(name="", labels = stage_converter) + theme(axis.text.x = element_text(angle = 35, hjust = 1, size=rel(1.15)))
p
### SUPP FIG
#p <- p + guides(colour = guide_legend(keywidth = 2, keyheight = 1, override.aes = list(size=c(1,1,1,1,0.1))))
### MAIN FIG
#p <- p + guides(colour = guide_legend(keywidth = 2, keyheight = 1, override.aes = list(size=c(1,1,1,0.1)))) #"Prioritized genes (structures)"=0.1
### VARIABLE
p <- p + labs(y="Mean median brain expression")
p
#main1_rnaseq_release_v1_median_NO_NEAREST-9x6.pdf
############### SYNAPSIS ###################
# Name: graphics_main1_median.R
# This script is a newer version of "graphics_main1.R".
# The script LOADs EITHER microarray data OR PROCESSED RNAseq data.
# It was created to be able to handle multiple gene list for plotting. The script uses plyr to load in multiple gene lists.
# You may choose what files to load
# The script also process and loads GILMAN gene clusters (1, 1a, 1b and 2)
# The script was used to generate PUBLICATION READY GRAPHICS
# THIS VERSION TAKES THE MEDIAN GENE EXPRESSION VALUES.
############################################
library(plyr)
library(ggplot2)
library(reshape2)
library(tools) # for file_path_sans_ext
rm(list=ls())
wd <- path.expand("~/p_EAv2/git/EAv2/src")
setwd(wd)
release <- "release_v1"
############################# LOAD EXPRESSION DATA #################################
#load(file="RData/data_marray_expression.RData") # df.expression_matrix.clean, df.expression_matrix.clean.melt
load(file="RData/data_rnaseq_expression_processed.RData") # RNAseq AFTER PROCESSING | df.expression_matrix.clean, df.expression_matrix.clean.melt
str(df.expression_matrix.clean.melt)
############################# READING GENE LISTs #################################
path.datafiles <- path.expand(sprintf("~/p_EAv2/git/EAv2/gene_lists/%s", release))
###### Read SPECIFIC FILES:
filenames2read <- c("gene_associated.txt", "gene_nearest.txt", "gene_prioritization.txt")
files <- as.list(paste(path.datafiles, filenames2read, sep="/"))
names(files) <- filenames2read
files
list_of_data <- llply(files, read.csv)#row.names = 1 --> NO!, stringsAsFactors = FALSE
names(list_of_data)
extract_genes_from_molten_df <- function(df_gene_list) {
print("done")
df <- subset(df.expression_matrix.clean.melt, ensembl_gene_id %in% df_gene_list[,1])
}
df.gene_list <- ldply(list_of_data, extract_genes_from_molten_df, .id="gene_list")
## Converting .id=gene_list to factor
df.gene_list$gene_list <- as.factor(df.gene_list$gene_list)
str(df.gene_list)
levels(df.gene_list$gene_list)
###################################### PROCESSING GENE lists ################################
###### Mean per stage/structure ########
df.summary <- ddply(df.gene_list, c("stage", "structure_acronym", "gene_list"), summarise,
mean = median(value, na.rm=TRUE),
sd   = sd(value, na.rm=TRUE))
## plyr magic for renaming factor level
levels(df.summary$gene_list)
df.summary$gene_list <- revalue(df.summary$gene_list, c("gene_associated.txt"="Associated Genes", "gene_nearest.txt"="Nearest Genes", "gene_prioritization.txt"="Prioritized Genes"))
levels(df.summary$gene_list)
###### Mean per stage - FINAL ##########
df.summary.sem <- ddply(df.summary, c("stage","gene_list"), summarise,
mean1 = mean(mean, na.rm=TRUE),
sd1   = sd(mean, na.rm=TRUE))
###################################### Calculating overall mean ################################
### *** Runtime ~ 10 s ***
df.all.sem <- ddply(ddply(df.expression_matrix.clean.melt, .(stage, structure_acronym), summarise, mean=median(value, na.rm=TRUE)), .(stage), summarise, mean1=mean(mean, na.rm=TRUE),  sd1=sd(mean, na.rm=TRUE))
###################################### Save DATA ################################
#save(file="RData/data_rnaseq_expression_processed_with_gene_lists.RData")
###################################### PLOT - 1 ################################
########### PLOT IT! ###########
p <- ggplot()
p <- p + geom_line(data=subset(df.summary, gene_list == "Prioritized Genes"), aes(x=stage, y=mean, group=structure_acronym, color="Prioritized genes (structures)")) #linetype="Brain regions"
p
### Adding mean Prioritized
p <- p + geom_line(data=subset(df.summary.sem, gene_list == "Prioritized Genes"), aes(x=stage, y=mean1, group=1, color="Prioritized genes"), linetype='solid', size=1)
p <- p + geom_errorbar(data=subset(df.summary.sem, gene_list == "Prioritized Genes"), aes(x=stage, ymax=mean1+sd1, ymin=mean1-sd1),color='#d7191c', width=0.2)
p
### Adding mean ALL (df.all.sem)
p <- p + geom_line(data=df.all.sem, aes(x=stage, y=mean1, group=1, color="All genes"), linetype='solid', size=1)
p <- p + geom_errorbar(data=df.all.sem, aes(x=stage, ymax=mean1+sd1, ymin=mean1-sd1),color='black', width=0.2)
p
### Adding Nearest Genes
#p <- p + geom_line(data=subset(df.summary.sem, gene_list == "Nearest Genes"), aes(x=stage, y=mean1, group=1, color="Nearest genes"), linetype='solid', size=1)
#p <- p + geom_errorbar(data=subset(df.summary.sem, gene_list == "Nearest Genes"), aes(x=stage, ymax=mean1+sd1, ymin=mean1-sd1), color='sky blue', width=0.2)
#p
### Adding Associated Genes
p <- p + geom_line(data=subset(df.summary.sem, gene_list == "Associated Genes"), aes(x=stage, y=mean1, group=1, color="Associated genes"), linetype='solid', size=1)
p <- p + geom_errorbar(data=subset(df.summary.sem, gene_list == "Associated Genes"), aes(x=stage, ymax=mean1+sd1, ymin=mean1-sd1), color='orange', width=0.2)
p
p <- p + scale_color_manual(name="Gene list", values=c(
"Prioritized genes (structures)"="gray",
"Prioritized genes"="#d7191c",
"All genes"="black",
"Nearest genes"="orange",
"Associated genes"="orange",
guide='legend'))
p
###### Adding vertical line - prenatal vs. postnatal
p <- p + geom_vline(xintercept=6.5, color="black", linetype="dashed")
p
######### Adding x-tickmarks for stage
stage_converter <- c("s1"="Embryonic",
"s2a"="Early prenatal",
"s2b"="Early prenatal",
"s3a"="Early mid-prenatal",
"s3b"="Early mid-prenatal",
"s4"="Late mid-prenatal",
"s5"="Late prenatal",
"s6"="Early infancy",
"s7"="Late infancy",
"s8"="Early childhood",
"s9"="Late childhood",
"s10"="Adolescence",
"s11"="Adulthood")
p <- p + scale_x_discrete(name="", labels = stage_converter) + theme(axis.text.x = element_text(angle = 35, hjust = 1, size=rel(1.15)))
p
### SUPP FIG
#p <- p + guides(colour = guide_legend(keywidth = 2, keyheight = 1, override.aes = list(size=c(1,1,1,1,0.1))))
### MAIN FIG
#p <- p + guides(colour = guide_legend(keywidth = 2, keyheight = 1, override.aes = list(size=c(1,1,1,0.1)))) #"Prioritized genes (structures)"=0.1
### VARIABLE
p <- p + labs(y="Mean median brain expression")
p
#main1_rnaseq_release_v1_median_NO_NEAREST-9x6.pdf
p <- p + geom_line(data=subset(df.summary.sem, gene_list == "Nearest Genes"), aes(x=stage, y=mean1, group=1, color="Nearest genes"), linetype='solid', size=1)
p <- p + geom_errorbar(data=subset(df.summary.sem, gene_list == "Nearest Genes"), aes(x=stage, ymax=mean1+sd1, ymin=mean1-sd1), color='sky blue', width=0.2)
p <- ggplot()
p <- p + geom_line(data=subset(df.summary, gene_list == "Prioritized Genes"), aes(x=stage, y=mean, group=structure_acronym, color="Prioritized genes (structures)")) #linetype="Brain regions"
p
### Adding mean Prioritized
p <- p + geom_line(data=subset(df.summary.sem, gene_list == "Prioritized Genes"), aes(x=stage, y=mean1, group=1, color="Prioritized genes"), linetype='solid', size=1)
p <- p + geom_errorbar(data=subset(df.summary.sem, gene_list == "Prioritized Genes"), aes(x=stage, ymax=mean1+sd1, ymin=mean1-sd1),color='#d7191c', width=0.2)
p
### Adding mean ALL (df.all.sem)
p <- p + geom_line(data=df.all.sem, aes(x=stage, y=mean1, group=1, color="All genes"), linetype='solid', size=1)
p <- p + geom_errorbar(data=df.all.sem, aes(x=stage, ymax=mean1+sd1, ymin=mean1-sd1),color='black', width=0.2)
p
### Adding Nearest Genes
p <- p + geom_line(data=subset(df.summary.sem, gene_list == "Nearest Genes"), aes(x=stage, y=mean1, group=1, color="Nearest genes"), linetype='solid', size=1)
p <- p + geom_errorbar(data=subset(df.summary.sem, gene_list == "Nearest Genes"), aes(x=stage, ymax=mean1+sd1, ymin=mean1-sd1), color='sky blue', width=0.2)
p
### Adding Associated Genes
p <- p + geom_line(data=subset(df.summary.sem, gene_list == "Associated Genes"), aes(x=stage, y=mean1, group=1, color="Associated genes"), linetype='solid', size=1)
p <- p + geom_errorbar(data=subset(df.summary.sem, gene_list == "Associated Genes"), aes(x=stage, ymax=mean1+sd1, ymin=mean1-sd1), color='orange', width=0.2)
p
p <- p + scale_color_manual(name="Gene list", values=c(
"Prioritized genes (structures)"="gray",
"Prioritized genes"="#d7191c",
"All genes"="black",
"Nearest genes"="orange",
"Associated genes"="orange",
guide='legend'))
p
###### Adding vertical line - prenatal vs. postnatal
p <- p + geom_vline(xintercept=6.5, color="black", linetype="dashed")
p
######### Adding x-tickmarks for stage
stage_converter <- c("s1"="Embryonic",
"s2a"="Early prenatal",
"s2b"="Early prenatal",
"s3a"="Early mid-prenatal",
"s3b"="Early mid-prenatal",
"s4"="Late mid-prenatal",
"s5"="Late prenatal",
"s6"="Early infancy",
"s7"="Late infancy",
"s8"="Early childhood",
"s9"="Late childhood",
"s10"="Adolescence",
"s11"="Adulthood")
p <- p + scale_x_discrete(name="", labels = stage_converter) + theme(axis.text.x = element_text(angle = 35, hjust = 1, size=rel(1.15)))
p
### SUPP FIG
#p <- p + guides(colour = guide_legend(keywidth = 2, keyheight = 1, override.aes = list(size=c(1,1,1,1,0.1))))
### MAIN FIG
#p <- p + guides(colour = guide_legend(keywidth = 2, keyheight = 1, override.aes = list(size=c(1,1,1,0.1)))) #"Prioritized genes (structures)"=0.1
### VARIABLE
p <- p + labs(y="Mean median brain expression")
p
#main1_rnaseq_release_v1_median_NO_NEAREST-9x6.pdf
p <- p + scale_color_manual(name="Gene list", values=c(
"Prioritized genes (structures)"="gray",
"Prioritized genes"="#d7191c",
"All genes"="black",
"Nearest genes"="sky blue",
"Associated genes"="orange",
guide='legend'))
p
library(plyr)
library(ggplot2)
library(reshape2)
library(tools) # for file_path_sans_ext
rm(list=ls())
wd <- path.expand("~/p_EAv2/git/EAv2/src")
setwd(wd)
release <- "release_v1"
####################################### SOURCE ###########################################
source("multiplot.R")
####################################### LOAD DATA ###########################################
load(file="RData/data_rnaseq_expression_processed_full_res.RData") # df.expression_matrix.clean, df.expression_matrix.clean.melt
########### Setting prioritization #########
file.gene_prioritization <- "../gene_lists/gene_prioritization.txt"
#file.gene_prioritization <- "../gene_lists/gene_associated.txt"
gene_list <- basename(file_path_sans_ext(file.gene_prioritization))
########### READ prioritization file ###########
df.gene_prioritization <- read.csv(file.gene_prioritization,h=T)
## Check mapping - compare to "df.expression_matrix.clean" NOT MOLTEN, will be too slow
sum(df.expression_matrix.clean$ensembl_gene_id %in% df.gene_prioritization[,1]) # mapped genes
########### Setting prioritization #########
file.gene_prioritization <- sprintf("../gene_lists/%s/gene_prioritization.txt", release)
#file.gene_prioritization <- sprintf("../gene_lists/%s/gene_associated.txt", release)
gene_list <- basename(file_path_sans_ext(file.gene_prioritization))
########### READ prioritization file ###########
df.gene_prioritization <- read.csv(file.gene_prioritization,h=T)
## Check mapping - compare to "df.expression_matrix.clean" NOT MOLTEN, will be too slow
sum(df.expression_matrix.clean$ensembl_gene_id %in% df.gene_prioritization[,1]) # mapped genes
sum(!df.gene_prioritization[,1] %in% df.expression_matrix.clean$ensembl_gene_id) # non-mapped genes
cat(as.character(df.gene_prioritization[!df.gene_prioritization[,1] %in% df.expression_matrix.clean$ensembl_gene_id,]), sep="\n") # print non-mapped genes
### Setting priorizied factor for MOLTEN df
df.expression_matrix.clean.melt$gene_type <- as.factor(ifelse(df.expression_matrix.clean.melt$ensembl_gene_id %in% df.gene_prioritization[,1], "prioritized", "other"))
table(df.expression_matrix.clean.melt$gene_type)
str(df.expression_matrix.clean.melt)
################################# STATISTICAL TESTs ##################################
################## PREPARING FOR TEST ###############
## subsetting on prioritized/associated genes
df.expression_matrix.clean.melt.priori <- subset(df.expression_matrix.clean.melt, gene_type=="prioritized")
## calculating mean for each gene in prenatal and postnatal
df.natal.gene.mean <- ddply(df.expression_matrix.clean.melt.priori, .(ensembl_gene_id, natal), summarise,
mean=mean(value, na.rm=T))
################## T-test: prenatal vs postnatal | *PAIRED* ###############
# df.tmp.prenatal <- subset(df.natal.gene.mean, natal=="prenatal")
# df.tmp.postnatal <- subset(df.natal.gene.mean, natal=="postnatal")
# fit.test <- t.test(df.tmp.postnatal$mean, df.tmp.prenatal$mean, alternative="greater", paired=TRUE)
# fit.test # USING VECTORS ---> 0.3211001
### t.test
levels(df.natal.gene.mean$natal)
fit1 <- t.test(mean~natal, data=df.natal.gene.mean, alternative="greater", paired=TRUE)
fit1
fit1$p.value
levels(df.natal.gene.mean$natal)
fit1 <- t.test(mean~natal, data=df.natal.gene.mean, alternative="less", paired=TRUE) # OBS: EAv2 is testing "less" (SCZ was testing alternative="greater")
fit1
fit1$p.value
### calculation odd's ratio
df.or <- ddply(df.natal.gene.mean, .(natal), summarise,
group_mean=mean(mean, na.rm=T))
df.or
or_log2_corrected <- (2^df.or[df.or$natal=="postnatal","group_mean"]-1)/(2^df.or[df.or$natal=="prenatal","group_mean"]-1)
#formula: or = ((2^mu1)-1)/((2^mu2)-1)
or_log2_corrected
### plotting distribution of mean values
q1 <- ggplot(df.natal.gene.mean, aes(x=mean, fill=natal)) + geom_histogram(aes(y=..density..)) +geom_density(alpha=0.8)
### plotting box plot
q2 <- ggplot(df.natal.gene.mean, aes(x=natal, y=mean, fill=natal)) + geom_boxplot()
multiplot(q1,q2)
1/0.7679962
# ---> We use this approach because it IS SIMILAR TO HOW WE PLOT DATA
# ---> This is not an weighted average approach
df.mean.prio <- ddply(ddply(df.expression_matrix.clean.melt.priori, .(ensembl_gene_id, stage, structure_acronym), summarise, mean=median(value, na.rm=TRUE)), .(ensembl_gene_id, stage), summarise, mean1=mean(mean, na.rm=TRUE),  sd1=sd(mean, na.rm=TRUE))
################# PREPARING FOR TEST - step#2: calculate mean value across all genes for each stage  ###############
### This data frame is only used for identifying the HIGHEST expressed stages and PLOTTING
df.mean.prio.stage <- ddply(df.mean.prio, .(stage), summarise,
mean_stage=mean(mean1),
sd_stage=sd(mean1))
################# PREPARING FOR TEST - step#3: plot it! #################
p <- ggplot(data=df.mean.prio, aes(x=stage, y=mean1)) + geom_line(aes(group=ensembl_gene_id, color=ensembl_gene_id))
p <- p + geom_line(data=df.mean.prio.stage, aes(x=stage, y=mean_stage, group=1), size=1.5, color="black")
p <- p + geom_errorbar(data=df.mean.prio.stage, aes(x=stage, y=mean_stage, ymin=mean_stage-sd_stage, ymax=mean_stage+sd_stage, group=1), size=1.5, color="black")
p
################# PREPARING FOR TEST - step#4: identify highest expressed stage #################
df.mean.prio.stage[order(-df.mean.prio.stage$mean_stage),]
### t.test
levels(df.natal.gene.mean$natal)
fit1 <- t.test(mean~natal, data=df.natal.gene.mean, alternative="less", paired=TRUE) # OBS: EAv2 is testing "less" (SCZ was testing alternative="greater")
fit1
fit1$p.value
### calculation odd's ratio
df.or <- ddply(df.natal.gene.mean, .(natal), summarise,
group_mean=mean(mean, na.rm=T))
df.or
or_log2_corrected <- (2^df.or[df.or$natal=="prenatal","group_mean"]-1)/(2^df.or[df.or$natal=="postnatal","group_mean"]-1)
#formula: or = ((2^mu1)-1)/((2^mu2)-1)
or_log2_corrected
##### WITH "prior" median for structure ######
# ---> We use this approach because it IS SIMILAR TO HOW WE PLOT DATA
# ---> This is not an weighted average approach
df.mean.prio <- ddply(ddply(df.expression_matrix.clean.melt.priori, .(ensembl_gene_id, stage, structure_acronym), summarise, mean=median(value, na.rm=TRUE)), .(ensembl_gene_id, stage), summarise, mean1=mean(mean, na.rm=TRUE),  sd1=sd(mean, na.rm=TRUE))
################# PREPARING FOR TEST - step#2: calculate mean value across all genes for each stage  ###############
### This data frame is only used for identifying the HIGHEST expressed stages and PLOTTING
df.mean.prio.stage <- ddply(df.mean.prio, .(stage), summarise,
mean_stage=mean(mean1),
sd_stage=sd(mean1))
################# PREPARING FOR TEST - step#3: plot it! #################
p <- ggplot(data=df.mean.prio, aes(x=stage, y=mean1)) + geom_line(aes(group=ensembl_gene_id, color=ensembl_gene_id))
p <- p + geom_line(data=df.mean.prio.stage, aes(x=stage, y=mean_stage, group=1), size=1.5, color="black")
p <- p + geom_errorbar(data=df.mean.prio.stage, aes(x=stage, y=mean_stage, ymin=mean_stage-sd_stage, ymax=mean_stage+sd_stage, group=1), size=1.5, color="black")
p
################# PREPARING FOR TEST - step#4: identify highest expressed stage #################
df.mean.prio.stage[order(-df.mean.prio.stage$mean_stage),]
stage_to_test_against <- "s3b" # SCZ="s11"
df_test_against <- subset(df.mean.prio, stage==stage_to_test_against)
df_rest <- subset(df.mean.prio, stage!=stage_to_test_against)
ttest_stage <- function(df) {
x <- df_test_against$mean1 # *OBS*: mean1
y <- df$mean1 # *OBS*: mean1
### *PAIRED t-test* ###
t.test(x, y, alternative="greater", paired=TRUE)$p.value # alternative = "greater" is the alternative that x has a larger mean than y.
#t.test(x, y, alternative="greater", paired=TRUE) # ---> use this in COMBINATION WITH dlply
}
#### Making tests
#df.ttest_stage.list <- dlply(df_rest, .(stage), ttest_stage)
df.ttest_stage <- ddply(df_rest, .(stage), ttest_stage)
#### Sorting by p-value
df.ttest_stage.ordered <- df.ttest_stage[order(-df.ttest_stage[,2]),]
df.ttest_stage.ordered
#### Get stages that are NOT significant after BONFERRONI CORRECTION
df.ttest_stage.ordered[df.ttest_stage.ordered[,2] > 0.05/10,]
str(df.expression_matrix.clean.melt)
levels(df.expression_matrix.clean.melt$structure_acronym)
file.map.prioritized <- path.expand(sprintf('~/p_EAv2/git/EAv2/gene_lists/%s/gene_prioritization.csv', release))
file.map.prioritized
df.map.prioritized <- read.csv(file.map.prioritized, h=F)
df.map.prioritized
df.map.prioritized <- read.table(file.map.prioritized, h=F)
df.map.prioritized <- read.table(file.map.prioritized, h=F, sep=" ")
df.map.prioritized
df.map.prioritized <- read.table(file.map.prioritized, h=F, sep="\t")
df.map.prioritized
file.map.prioritized <- path.expand(sprintf('~/p_EAv2/git/EAv2/gene_lists/%s/gene_prioritization_hgnc_map.txt', release))
df.map.prioritized <- read.table(file.map.prioritized, h=F, sep="\t")
############### SYNAPSIS ###################
# This script is the EXTENDED VERSION of "graphics_main1_median.R"
# The script loads the same gene lists, but also load the "null"
# The script will make additional statistical tests to plot
# Loads data for either RNAseq/Microarray and associated/prioritized null genes
############################################
library(plyr)
library(ggplot2)
library(reshape2)
library(tools) # for file_path_sans_ext
library(grid) # for unit() function
rm(list=ls())
wd <- path.expand("~/p_EAv2/git/EAv2/src")
setwd(wd)
release <- "release_v1"
############################# LOAD EXPRESSION DATA - HIGH RES #################################
#load(file="RData/data_marray_expression.RData") # df.expression_matrix.clean, df.expression_matrix.clean.melt
load(file="RData/data_rnaseq_expression_processed_full_res.RData") # RNAseq AFTER PROCESSING | df.expression_matrix.clean, df.expression_matrix.clean.melt
str(df.expression_matrix.clean.melt)
######## Defining new stages #########
source("function_def_stages.R", echo=TRUE)
source("function_load_gene_list_data_individual_gene_plots.R", echo=TRUE)
# --> do_stage_converter
# --> df.summary
# --> df.summary.sem
# --> df.all.sem
###################################### Save DATA ################################
#save.image(file="RData_tmp/XXXXXXXXXXX.RData")
########## Read ENSEMBL-2-HGNC mapping file for prioritized genes ##############
file.map.prioritized <- path.expand(sprintf('~/p_EAv2/git/EAv2/gene_lists/%s/gene_prioritization_hgnc_map.txt', release))
df.map.prioritized <- read.table(file.map.prioritized, h=F, sep="\t")
############### SYNAPSIS ###################
# This script is the EXTENDED VERSION of "graphics_main1_median.R"
# The script loads the same gene lists, but also load the "null"
# The script will make additional statistical tests to plot
# Loads data for either RNAseq/Microarray and associated/prioritized null genes
############################################
library(plyr)
library(ggplot2)
library(reshape2)
library(tools) # for file_path_sans_ext
library(grid) # for unit() function
rm(list=ls())
wd <- path.expand("~/p_EAv2/git/EAv2/src")
setwd(wd)
release <- "release_v1"
############################# LOAD EXPRESSION DATA - HIGH RES #################################
#load(file="RData/data_marray_expression.RData") # df.expression_matrix.clean, df.expression_matrix.clean.melt
load(file="RData/data_rnaseq_expression_processed_full_res.RData") # RNAseq AFTER PROCESSING | df.expression_matrix.clean, df.expression_matrix.clean.melt
str(df.expression_matrix.clean.melt)
######## Defining new stages #########
source("function_def_stages.R", echo=TRUE)
source("function_load_gene_list_data_individual_gene_plots.R", echo=TRUE)
# --> do_stage_converter
# --> df.summary
# --> df.summary.sem
# --> df.all.sem
###################################### Save DATA ################################
#save.image(file="RData_tmp/XXXXXXXXXXX.RData")
########## Read ENSEMBL-2-HGNC mapping file for prioritized genes ##############
file.map.prioritized <- path.expand(sprintf('~/p_EAv2/git/EAv2/gene_lists/%s/gene_prioritization_hgnc_map.txt', release))
df.map.prioritized <- read.table(file.map.prioritized, h=F, sep="\t")
############## SINGLE PLOT - one gene
### Subsetting genes
#gene_ens <- as.character(list_of_data[["gene_prioritization.txt"]][1,]) # OLD METHOD: ONE GENE
gene_ens <- as.character(df.map.prioritized[1,1]) # ONE GENE
df.sub <- subset(df.expression_matrix.clean.melt, (ensembl_gene_id==gene_ens & structure_acronym %in% c("DFC", "MFC", "OFC", "VFC")))
### constructing label: mapping ensembl-->hgnc
row_idx <- match(df.sub$ensembl_gene_id, df.map.prioritized[,1]) # No need for as.character(): match() --> factors are converted to character vectors,
hgnc_symbol <- as.character(df.map.prioritized[row_idx,2])
replacement_string <- paste(df.sub$ensembl_gene_id, "=", hgnc_symbol, sep="")
df.sub$facet_label <- replacement_string
### Making plot
p <- ggplot()
p <- p + geom_point(data=df.sub, aes(x=stage, y=value, color=structure_acronym))
p <- p + geom_smooth(data=df.sub, aes(x=stage, y=value, group=structure_acronym, color=structure_acronym), method="loess", alpha=0.1)
p + labs(title=unique(df.sub$facet_label))
############## FACET wrap
### Subsetting genes
gene_ens <- as.character(df.map.prioritized[,1]) # ALL GENES!
df.sub <- subset(df.expression_matrix.clean.melt, (ensembl_gene_id %in% gene_ens & structure_acronym %in% c("DFC", "MFC", "OFC", "VFC")))
### constructing label: mapping ensembl-->hgnc
row_idx <- match(df.sub$ensembl_gene_id, df.map.prioritized[,1]) # No need for as.character(): match() --> factors are converted to character vectors,
hgnc_symbol <- as.character(df.map.prioritized[row_idx,2])
# replacing unmapped genes (hgnc=="") with their ENSEMBL names:
df.sub$facet_label <- ifelse(hgnc_symbol!="", hgnc_symbol, as.character(df.sub$ensembl_gene_id))
### Making plot
p <- ggplot(data=df.sub)
p <- p + geom_point(data=df.sub, aes(x=stage, y=value, color=structure_acronym))
p <- p + geom_smooth(data=df.sub, aes(x=stage, y=value, group=structure_acronym, color=structure_acronym), method="loess", alpha=0.1)
p <- p + facet_wrap(~ facet_label)
## add mean of prioritized
p <- p + geom_line(data=subset(df.summary.sem, gene_list == "Prioritized Genes"), aes(x=stage, y=mean1, group=1, color="Mean all structures"), linetype='solid', size=1)
## add mean of all genes
#### SETTING LEGEND
cmap <- c("Mean all structures"="gray",
#p <- p + geom_line(data=df.all.sem, aes(x=stage, y=mean1, group=1), linetype='solid', color="Black", size=1)
"DFC"="#F8766D",
"MFC"="#7CAE00",
"VFC"="#C77CFF",
"OFC"="#00BFC4",
guide='legend')
p <- p + scale_color_manual(name="Brain structure", values=cmap)
p <- do_stage_converter(p)
## Setting x-axis text size (DIFFICULT!)
p <- p + theme(axis.text.x=element_text(size=8))
p <- p + labs(y="Mean brain expression")
### Setting text size for label/strip.text in facets
p <- p + theme(strip.text.x=element_text(size=16, colour="black", face="italic"))
### Setting axis.title size for y-axis
p <- p + theme(axis.title.y=element_text(size=20))
### Setting longer distance between x-axis tick marks
#p <- p + scale_x_discrete(expand=c(0.2,0)) # DOES NOT WORK. multiplicative and additive expansion constants
#p <- p + theme(axis.ticks.length=unit(10, 'mm')) #DOES NOT WORK.
#p + scale_x_discrete(breaks=c(1,2,3), labels=c("A1","A2","A3")) #DOES NOT WORK.
p
